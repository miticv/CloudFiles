<div class="flex flex-col w-full h-full min-w-0 overflow-auto">

    <!-- Not connected state -->
    <div *ngIf="!isGoogleConnected" class="flex flex-auto flex-col items-center justify-center">
        <mat-icon class="!text-[80px] !w-20 !h-20 text-black/15">photo_library</mat-icon>
        <div class="mt-4 text-xl font-semibold tracking-tight text-secondary">Google Not Connected</div>
        <div class="mt-2 text-sm text-secondary mb-6">Connect your Google account to browse your photos.</div>
        <button mat-flat-button color="primary" (click)="connectGoogle()">
            <mat-icon>login</mat-icon>
            Connect Google
        </button>
    </div>

    <!-- Connected state -->
    <ng-container *ngIf="isGoogleConnected">

        <!-- Header -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between p-6 sm:py-8 md:px-8 border-b bg-card">
            <div>
                <div class="text-3xl font-bold tracking-tight leading-none">Google Photos</div>
                <div class="mt-1 font-medium text-secondary">
                    {{pickedItems.length > 0 ? pickedItems.length + ' photo' + (pickedItems.length !== 1 ? 's' : '') + ' selected' : 'Select photos to migrate'}}
                </div>
            </div>
            <div class="flex items-center gap-3 mt-4 sm:mt-0">
                <button mat-icon-button (click)="openHelp()" matTooltip="Migration help">
                    <mat-icon>help_outline</mat-icon>
                </button>
                <button mat-flat-button color="primary" (click)="selectPhotos()" [disabled]="loading || polling">
                    <mat-icon>photo_library</mat-icon>
                    {{ pickedItems.length > 0 ? 'Select More' : 'Select Photos' }}
                </button>
                <button *ngIf="pickedItems.length > 0" mat-stroked-button (click)="clearSelection()"
                        [disabled]="loading || polling">
                    <mat-icon>clear_all</mat-icon>
                    Clear
                </button>
                <button mat-flat-button (click)="openCopyToAzure()"
                        [disabled]="loading || polling || pickedItems.length === 0"
                        class="btn-azure">
                    <mat-icon>cloud_download</mat-icon>
                    Copy to Azure
                </button>
            </div>
        </div>

        <!-- Polling state -->
        <div *ngIf="polling" class="spinner-wrapper">
            <mat-spinner diameter="44" strokeWidth="4"></mat-spinner>
            <p class="text-sm font-medium text-secondary">Waiting for photo selection...</p>
            <p class="text-xs text-secondary">Select photos in the Google Photos picker window</p>
        </div>

        <!-- Loading -->
        <div *ngIf="loading && !polling" class="spinner-wrapper">
            <mat-spinner diameter="44" strokeWidth="4"></mat-spinner>
            <p class="text-sm font-medium text-secondary">Loading photos...</p>
        </div>

        <!-- Error -->
        <div *ngIf="error" class="mx-6 md:mx-8 mt-4 p-4 rounded-xl flex items-center gap-3 bg-red-50 border border-red-200">
            <mat-icon class="text-red-600 !text-[20px] !w-5 !h-5">error_outline</mat-icon>
            <span class="flex-1 text-sm text-red-800">{{error}}</span>
            <button mat-icon-button (click)="selectPhotos()" matTooltip="Retry">
                <mat-icon>refresh</mat-icon>
            </button>
        </div>

        <!-- Empty state -->
        <div *ngIf="!loading && !polling && pickedItems.length === 0 && !error"
             class="flex flex-auto flex-col items-center justify-center">
            <mat-icon class="!text-[80px] !w-20 !h-20 text-black/15">collections</mat-icon>
            <div class="mt-4 text-xl font-semibold tracking-tight text-secondary">No photos selected</div>
            <div class="mt-2 text-sm text-secondary">Click the button above to pick photos from Google.</div>
            <div class="mt-4 px-4 py-3 rounded-lg text-xs text-secondary max-w-md text-center"
                 style="background: #f0f4ff; border: 1px solid #e0e7ff;">
                <mat-icon class="!text-[14px] !w-3.5 !h-3.5 align-middle mr-1" style="color: #6366f1;">tips_and_updates</mat-icon>
                Tip: In the Google Photos picker, search by album name to find and select photos from specific albums.
                You can open the picker multiple times to accumulate selections.
            </div>
        </div>

        <!-- Photos grid -->
        <div *ngIf="!loading && !polling && pickedItems.length > 0"
            class="p-6 md:p-8 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3">
            <div *ngFor="let item of pickedItems"
                class="photo-card cursor-pointer"
                (click)="viewPhoto(item)"
                [matTooltip]="item.mediaFile.filename">
                <img [secureImage]="getThumbUrl(item)" [alt]="item.mediaFile.filename">
            </div>
        </div>

    </ng-container>
</div>
