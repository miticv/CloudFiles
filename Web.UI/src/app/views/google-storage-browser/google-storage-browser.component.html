<div class="flex flex-col h-full min-w-0 overflow-auto">

    <!-- Not connected state -->
    <div *ngIf="!isGoogleConnected" class="flex flex-auto flex-col items-center justify-center py-16">
        <mat-icon style="font-size: 80px; width: 80px; height: 80px; color: rgba(0,0,0,0.15);">cloud_off</mat-icon>
        <div class="mt-4 text-xl font-semibold tracking-tight text-secondary">Google Not Connected</div>
        <div class="mt-2 text-sm text-secondary mb-6">Connect your Google account to browse cloud storage.</div>
        <button mat-flat-button color="primary" (click)="connectGoogle()">
            <mat-icon>login</mat-icon>
            Connect Google
        </button>
    </div>

    <!-- Connected state -->
    <ng-container *ngIf="isGoogleConnected">

        <!-- ==================== SETUP VIEW ==================== -->
        <ng-container *ngIf="currentView === 'setup'">
            <div class="flex flex-auto flex-col items-center justify-center p-6">
                <mat-icon style="font-size: 64px; width: 64px; height: 64px;" class="text-teal-400">cloud_circle</mat-icon>
                <div class="mt-4 text-2xl font-bold tracking-tight">Google Cloud Storage</div>
                <div class="mt-1 text-sm text-secondary mb-8">Enter a bucket name to browse, or a project ID to discover buckets.</div>

                <div class="setup-card space-y-6">
                    <!-- Browse by bucket -->
                    <div class="p-5 rounded-xl border border-gray-200 bg-card">
                        <div class="font-semibold text-sm mb-3">Browse by Bucket</div>
                        <div class="flex items-end gap-3">
                            <mat-form-field appearance="outline" class="flex-1" subscriptSizing="dynamic">
                                <mat-label>Bucket name</mat-label>
                                <input matInput [(ngModel)]="bucketInput" placeholder="my-bucket"
                                       (keydown.enter)="browseBucket()">
                            </mat-form-field>
                            <button mat-flat-button color="primary"
                                    [disabled]="!bucketInput.trim()" (click)="browseBucket()">
                                Browse
                            </button>
                        </div>
                    </div>

                    <!-- Find by project -->
                    <div class="p-5 rounded-xl border border-gray-200 bg-card">
                        <div class="font-semibold text-sm mb-3">Find Buckets by Project</div>
                        <div class="flex items-end gap-3">
                            <mat-form-field appearance="outline" class="flex-1" subscriptSizing="dynamic">
                                <mat-label>Project ID</mat-label>
                                <input matInput [(ngModel)]="projectInput" placeholder="my-gcp-project"
                                       (keydown.enter)="findBuckets()">
                            </mat-form-field>
                            <button mat-flat-button color="accent"
                                    [disabled]="!projectInput.trim() || loading" (click)="findBuckets()">
                                {{loading ? 'Loading...' : 'List Buckets'}}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Error -->
                <div *ngIf="error" class="mt-6 p-4 rounded-xl flex items-center gap-3 setup-card"
                     style="background: #fef2f2; border: 1px solid #fecaca;">
                    <mat-icon style="color: #dc2626; font-size: 20px; width: 20px; height: 20px;">error_outline</mat-icon>
                    <span class="flex-1 text-sm" style="color: #991b1b;">{{error}}</span>
                </div>
            </div>
        </ng-container>

        <!-- ==================== BUCKETS VIEW ==================== -->
        <ng-container *ngIf="currentView === 'buckets'">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between p-6 sm:py-8 md:px-8 border-b bg-card">
                <div>
                    <div class="text-3xl font-bold tracking-tight leading-none">Google Storage</div>
                    <div class="mt-1 font-medium text-secondary">Buckets in project</div>
                </div>
                <div class="flex items-center gap-1 mt-4 sm:mt-0">
                    <button mat-icon-button class="header-btn" (click)="backToSetup()" matTooltip="Back">
                        <mat-icon>arrow_back</mat-icon>
                    </button>
                    <button mat-icon-button class="header-btn" (click)="refresh()" matTooltip="Refresh">
                        <mat-icon>refresh</mat-icon>
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div *ngIf="loading" class="flex flex-col items-center justify-center gap-4 py-16">
                <mat-spinner diameter="44" strokeWidth="4"></mat-spinner>
                <p class="text-sm font-medium" style="color: rgba(0,0,0,0.6);">Loading buckets...</p>
            </div>

            <!-- Error -->
            <div *ngIf="error" class="mx-6 md:mx-8 mt-4 p-4 rounded-xl flex items-center gap-3"
                 style="background: #fef2f2; border: 1px solid #fecaca;">
                <mat-icon style="color: #dc2626; font-size: 20px; width: 20px; height: 20px;">error_outline</mat-icon>
                <span class="flex-1 text-sm" style="color: #991b1b;">{{error}}</span>
                <button mat-icon-button (click)="refresh()" matTooltip="Retry">
                    <mat-icon>refresh</mat-icon>
                </button>
            </div>

            <!-- Bucket list -->
            <div class="px-6 md:px-8 pb-6" *ngIf="!loading">
                <mat-nav-list>
                    <mat-list-item *ngFor="let bucket of buckets" (click)="selectBucket(bucket)">
                        <mat-icon matListItemIcon class="text-teal-500">cloud_circle</mat-icon>
                        <div matListItemTitle>{{bucket.name}}</div>
                        <div matListItemLine class="text-secondary text-xs">
                            {{bucket.location}} &middot; {{bucket.storageClass}}
                        </div>
                        <span matListItemMeta><mat-icon class="trail-icon">chevron_right</mat-icon></span>
                    </mat-list-item>
                    <div *ngIf="buckets.length === 0 && !error" class="text-center py-8 text-secondary">
                        No buckets found in this project.
                    </div>
                </mat-nav-list>
            </div>
        </ng-container>

        <!-- ==================== BROWSE VIEW ==================== -->
        <ng-container *ngIf="currentView === 'browse'">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between p-6 sm:py-8 md:px-8 border-b bg-card">
                <div>
                    <div class="text-3xl font-bold tracking-tight leading-none">Google Storage</div>
                    <div class="mt-1 font-medium text-secondary">
                        <mat-icon style="font-size: 16px; width: 16px; height: 16px; vertical-align: text-bottom;">cloud_circle</mat-icon>
                        {{currentBucket}}
                    </div>
                </div>
                <div class="flex items-center gap-1 mt-4 sm:mt-0">
                    <button mat-icon-button class="header-btn" (click)="backToSetup()" matTooltip="Change bucket">
                        <mat-icon>arrow_back</mat-icon>
                    </button>
                    <button mat-icon-button class="header-btn" (click)="refresh()" matTooltip="Refresh">
                        <mat-icon>refresh</mat-icon>
                    </button>
                </div>
            </div>

            <!-- Breadcrumbs -->
            <nav class="flex items-center mx-6 md:mx-8 mt-4 mb-4 text-sm">
                <button mat-button class="px-2 min-w-0" (click)="navigateToBreadcrumb(-1)">
                    <mat-icon class="mr-1" style="font-size: 18px; width: 18px; height: 18px;">home</mat-icon>
                    Root
                </button>
                <ng-container *ngFor="let segment of currentPath; let i = index; let last = last">
                    <mat-icon class="text-gray-400" style="font-size: 18px; width: 18px; height: 18px;">chevron_right</mat-icon>
                    <button mat-button class="px-2 min-w-0" [disabled]="last" (click)="navigateToBreadcrumb(i)">
                        {{segment}}
                    </button>
                </ng-container>
            </nav>

            <!-- Loading -->
            <div *ngIf="loading" class="flex flex-col items-center justify-center gap-4 py-16">
                <mat-spinner diameter="44" strokeWidth="4"></mat-spinner>
                <p class="text-sm font-medium" style="color: rgba(0,0,0,0.6);">Loading...</p>
            </div>

            <!-- Error -->
            <div *ngIf="error" class="mx-6 md:mx-8 mt-4 p-4 rounded-xl flex items-center gap-3"
                 style="background: #fef2f2; border: 1px solid #fecaca;">
                <mat-icon style="color: #dc2626; font-size: 20px; width: 20px; height: 20px;">error_outline</mat-icon>
                <span class="flex-1 text-sm" style="color: #991b1b;">{{error}}</span>
                <button mat-icon-button (click)="refresh()" matTooltip="Retry">
                    <mat-icon>refresh</mat-icon>
                </button>
            </div>

            <!-- File/Folder list -->
            <div class="px-6 md:px-8 pb-6" *ngIf="!loading">
                <div *ngIf="folders.length > 0 || files.length > 0; else noItems">

                    <!-- Folders -->
                    <mat-nav-list *ngIf="folders.length > 0">
                        <div class="font-medium text-sm text-secondary mb-1 mt-2">Folders</div>
                        <mat-list-item *ngFor="let folder of folders" (click)="navigateToFolder(folder)">
                            <mat-icon matListItemIcon class="text-amber-500">folder</mat-icon>
                            <div matListItemTitle>{{folder.itemName}}</div>
                            <span matListItemMeta><mat-icon class="trail-icon">chevron_right</mat-icon></span>
                        </mat-list-item>
                    </mat-nav-list>

                    <!-- Files -->
                    <mat-nav-list *ngIf="files.length > 0">
                        <div class="font-medium text-sm text-secondary mb-1 mt-4">Files</div>
                        <mat-list-item *ngFor="let file of files">
                            <mat-icon matListItemIcon class="text-blue-400">description</mat-icon>
                            <div matListItemTitle>{{file.itemName}}</div>
                            <div matListItemLine class="text-secondary text-xs">
                                <span class="type-badge" [ngClass]="getFileTypeBg(file.itemType)">{{file.itemType}}</span>
                            </div>
                        </mat-list-item>
                    </mat-nav-list>

                </div>

                <ng-template #noItems>
                    <div *ngIf="!error" class="flex flex-col items-center justify-center py-16">
                        <mat-icon style="font-size: 80px; width: 80px; height: 80px; color: rgba(0,0,0,0.15);">folder_open</mat-icon>
                        <div class="mt-4 text-xl font-semibold tracking-tight text-secondary">No items found</div>
                        <div class="mt-2 text-sm text-secondary">This folder is empty.</div>
                    </div>
                </ng-template>
            </div>
        </ng-container>

    </ng-container>
</div>
