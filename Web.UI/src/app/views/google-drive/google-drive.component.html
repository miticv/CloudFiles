<div class="flex flex-col w-full h-full min-w-0 overflow-auto">

    <!-- Not connected state -->
    <div *ngIf="!isGoogleConnected" class="flex flex-auto flex-col items-center justify-center py-16">
        <mat-icon class="!text-[80px] !w-20 !h-20 text-black/15">folder_shared</mat-icon>
        <div class="mt-4 text-xl font-semibold tracking-tight text-secondary">Google Not Connected</div>
        <div class="mt-2 text-sm text-secondary mb-6">Connect your Google account to browse your Drive.</div>
        <button mat-flat-button color="primary" (click)="connectGoogle()">
            <mat-icon>login</mat-icon>
            Connect Google
        </button>
    </div>

    <!-- Connected state -->
    <ng-container *ngIf="isGoogleConnected">

        <!-- Header -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between p-6 sm:py-8 md:px-8 border-b bg-card sticky top-0 z-10">
            <div>
                <div class="text-3xl font-bold tracking-tight leading-none">Google Drive</div>
                <div class="mt-1 font-medium text-secondary">
                    {{selectedFiles.size > 0 ? selectedFiles.size + ' file' + (selectedFiles.size !== 1 ? 's' : '') + ' selected' : 'Browse and select files to copy'}}
                </div>
            </div>
            <div class="flex items-center gap-1 mt-4 sm:mt-0">
                <button mat-icon-button class="header-btn" (click)="refresh()" matTooltip="Refresh" [disabled]="loading">
                    <mat-icon>refresh</mat-icon>
                </button>
                <button mat-flat-button (click)="openCopyToAzure()"
                        [disabled]="loading || selectedFiles.size === 0"
                        class="btn-azure ml-2">
                    <mat-icon>cloud_download</mat-icon>
                    Copy to Azure
                </button>
            </div>
        </div>

        <!-- Breadcrumbs -->
        <nav class="flex items-center mx-6 md:mx-8 mt-4 mb-4 text-sm">
            <button mat-button class="px-2 min-w-0" (click)="navigateToBreadcrumb(-1)">
                <mat-icon class="mr-1 !text-[18px] !w-[18px] !h-[18px]">home</mat-icon>
                My Drive
            </button>
            <ng-container *ngFor="let crumb of breadcrumbs; let i = index; let last = last">
                <mat-icon class="text-gray-300 !text-[18px] !w-[18px] !h-[18px]">chevron_right</mat-icon>
                <button mat-button class="px-2 min-w-0" [disabled]="last" (click)="navigateToBreadcrumb(i)">
                    {{crumb.name}}
                </button>
            </ng-container>
        </nav>

        <!-- Loading -->
        <div *ngIf="loading" class="flex flex-col items-center justify-center gap-4 py-16">
            <mat-spinner diameter="44" strokeWidth="4"></mat-spinner>
            <p class="text-sm font-medium text-secondary">Loading...</p>
        </div>

        <!-- Error -->
        <div *ngIf="error" class="mx-6 md:mx-8 mt-4 p-4 rounded-xl flex items-center gap-3 bg-red-50 border border-red-200">
            <mat-icon class="text-red-600 !text-[20px] !w-5 !h-5">error_outline</mat-icon>
            <span class="flex-1 text-sm text-red-800">{{error}}</span>
            <button mat-icon-button (click)="refresh()" matTooltip="Retry">
                <mat-icon>refresh</mat-icon>
            </button>
        </div>

        <!-- File/Folder list -->
        <div class="px-6 md:px-8 pb-6" *ngIf="!loading">
            <div *ngIf="folders.length > 0 || selectableFiles.length > 0 || nonSelectableFiles.length > 0; else noItems">

                <!-- Folders -->
                <mat-nav-list *ngIf="folders.length > 0">
                    <div class="font-medium text-sm text-secondary mb-1 mt-2">Folders</div>
                    <mat-list-item *ngFor="let folder of folders" (click)="navigateToFolder(folder)">
                        <mat-icon matListItemIcon class="text-amber-500">folder</mat-icon>
                        <div matListItemTitle>{{folder.name}}</div>
                        <span matListItemMeta><mat-icon class="trail-icon">chevron_right</mat-icon></span>
                    </mat-list-item>
                </mat-nav-list>

                <!-- Selectable Files -->
                <mat-nav-list *ngIf="selectableFiles.length > 0">
                    <div class="font-medium text-sm text-secondary mb-1 mt-4 flex items-center gap-2">
                        <mat-checkbox [checked]="allSelectableSelected"
                                      [indeterminate]="selectedFiles.size > 0 && !allSelectableSelected"
                                      (change)="toggleSelectAll()"
                                      color="primary">
                        </mat-checkbox>
                        Files
                        <span class="text-xs text-gray-400">({{selectableFiles.length}})</span>
                    </div>
                    <mat-list-item *ngFor="let file of selectableFiles" (click)="toggleSelection(file)">
                        <mat-checkbox matListItemIcon [checked]="isSelected(file)" color="primary"
                                      (click)="$event.stopPropagation()" (change)="toggleSelection(file)">
                        </mat-checkbox>
                        <div matListItemTitle class="flex items-center gap-2">
                            <mat-icon class="text-blue-400 !text-[20px] !w-5 !h-5">{{getFileIcon(file)}}</mat-icon>
                            {{file.name}}
                        </div>
                        <div matListItemLine class="text-secondary text-xs flex items-center gap-2">
                            <span class="type-badge" [ngClass]="getFileTypeBg(file)">{{getFileTypeLabel(file)}}</span>
                            <span *ngIf="file.size">{{formatSize(file.size)}}</span>
                        </div>
                    </mat-list-item>
                </mat-nav-list>

                <!-- Non-selectable Google Docs files -->
                <mat-nav-list *ngIf="nonSelectableFiles.length > 0">
                    <div class="font-medium text-sm text-secondary mb-1 mt-4">
                        Google Docs
                        <span class="text-xs text-gray-400">(cannot be copied)</span>
                    </div>
                    <mat-list-item *ngFor="let file of nonSelectableFiles" class="opacity-50">
                        <mat-icon matListItemIcon class="text-gray-400 !text-[20px] !w-5 !h-5">
                            {{getFileIcon(file)}}
                        </mat-icon>
                        <div matListItemTitle>{{file.name}}</div>
                        <div matListItemLine class="text-secondary text-xs">
                            <span class="type-badge" [ngClass]="getFileTypeBg(file)">{{getFileTypeLabel(file)}}</span>
                        </div>
                    </mat-list-item>
                </mat-nav-list>

                <!-- Load More -->
                <div *ngIf="nextPageToken" class="mt-4 text-center">
                    <button mat-stroked-button (click)="loadMore()">
                        <mat-icon>expand_more</mat-icon>
                        Load More
                    </button>
                </div>

            </div>

            <ng-template #noItems>
                <div *ngIf="!error" class="flex flex-col items-center justify-center py-16">
                    <mat-icon class="!text-[80px] !w-20 !h-20 text-black/15">folder_open</mat-icon>
                    <div class="mt-4 text-xl font-semibold tracking-tight text-secondary">No items found</div>
                    <div class="mt-2 text-sm text-secondary">This folder is empty.</div>
                </div>
            </ng-template>
        </div>

    </ng-container>
</div>
