<div class="flex flex-col w-full h-full min-w-0 overflow-auto">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between p-6 sm:py-8 md:px-8 border-b bg-card sticky top-0 z-10">
        <div class="flex-1 min-w-0">
            <div class="text-3xl font-bold tracking-tight leading-none">Processes</div>
            <div class="mt-1 font-medium text-secondary">
                {{groups.length}} orchestration group{{groups.length !== 1 ? 's' : ''}}
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 mt-4 sm:mt-0 flex-shrink-0 ml-auto">
            <!-- From date -->
            <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic"
                            style="width: 165px;" floatLabel="never">
                <input matInput [matDatepicker]="fromPicker" [(ngModel)]="fromDate"
                       (dateChange)="onDateChange()" placeholder="From">
                <mat-datepicker-toggle matIconSuffix [for]="fromPicker"></mat-datepicker-toggle>
                <mat-datepicker #fromPicker></mat-datepicker>
            </mat-form-field>
            <!-- To date -->
            <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic"
                            style="width: 165px;" floatLabel="never">
                <input matInput [matDatepicker]="toPicker" [(ngModel)]="toDate"
                       (dateChange)="onDateChange()" placeholder="To">
                <mat-datepicker-toggle matIconSuffix [for]="toPicker"></mat-datepicker-toggle>
                <mat-datepicker #toPicker></mat-datepicker>
            </mat-form-field>
            <mat-form-field appearance="outline" class="filter-field" subscriptSizing="dynamic"
                            style="width: 180px; min-width: 180px;" floatLabel="never">
                <mat-select [(ngModel)]="statusFilter" (selectionChange)="onFilterChange()" multiple
                            panelClass="filter-panel" placeholder="Filter by status">
                    <mat-option [value]="0">Running</mat-option>
                    <mat-option [value]="1">Completed</mat-option>
                    <mat-option [value]="3">Failed</mat-option>
                    <mat-option [value]="6">Pending</mat-option>
                    <mat-option [value]="5">Terminated</mat-option>
                </mat-select>
            </mat-form-field>
            <button *ngIf="isAdmin" mat-stroked-button (click)="toggleShowAll()"
                    [color]="showAll ? 'primary' : ''"
                    [matTooltip]="showAll ? 'Showing all users\' processes' : 'Showing your processes only'">
                <mat-icon>{{ showAll ? 'supervisor_account' : 'person' }}</mat-icon>
                {{ showAll ? 'All Users' : 'My Processes' }}
            </button>
            <button mat-icon-button class="toolbar-btn" (click)="loadInstances()" matTooltip="Refresh">
                <mat-icon>refresh</mat-icon>
            </button>
        </div>
    </div>

    <!-- Error -->
    <div *ngIf="error" class="mx-6 md:mx-8 mt-4 p-4 rounded-xl flex items-center gap-3 bg-red-50 border border-red-200">
        <mat-icon class="text-red-600 !text-[20px] !w-5 !h-5">error_outline</mat-icon>
        <span class="flex-1 text-sm text-red-800">{{error}}</span>
        <button mat-icon-button (click)="loadInstances()" matTooltip="Retry">
            <mat-icon>refresh</mat-icon>
        </button>
    </div>

    <!-- Loading -->
    <div *ngIf="loading && instances.length === 0" class="spinner-wrapper">
        <mat-spinner diameter="44" strokeWidth="4"></mat-spinner>
        <p class="text-sm font-medium text-secondary">Loading processes...</p>
    </div>

    <!-- Grouped instance list -->
    <div class="p-6 md:p-8 space-y-4" *ngIf="groups.length > 0">
        <div *ngFor="let group of groups"
             class="bg-card rounded-xl shadow-sm border border-gray-100 overflow-hidden">

            <!-- Parent row -->
            <div class="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                 (click)="toggleExpand(group.parent.instanceId)">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center gap-3 min-w-0">
                        <mat-icon [class]="statusColors[getEffectiveStatus(group.parent)]"
                                  class="rounded-full p-0.5 !text-[20px] !w-5 !h-5">
                            {{statusIcons[getEffectiveStatus(group.parent)]}}
                        </mat-icon>
                        <span class="px-2 py-0.5 rounded text-xs font-semibold whitespace-nowrap"
                              [ngClass]="statusColors[getEffectiveStatus(group.parent)]">
                            {{statusLabels[getEffectiveStatus(group.parent)]}}
                        </span>
                        <span class="font-medium text-sm truncate">{{getDisplayName(group.parent.name)}}</span>
                        <span *ngIf="getInputSummary(group.parent)" class="text-xs text-secondary hidden md:inline">
                            ({{getInputSummary(group.parent)}})
                        </span>
                        <span *ngIf="group.children.length > 0"
                              class="px-1.5 py-0.5 rounded-full text-xs bg-gray-100 text-gray-600 hidden sm:inline">
                            +{{group.children.length}} sub
                        </span>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-secondary whitespace-nowrap">
                        <ng-container *ngFor="let entry of getStartedByEntries(group.parent); trackBy: trackByEmail">
                            <span class="hidden lg:inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium"
                                  [ngClass]="entry.provider === 'azure'
                                      ? 'bg-sky-100 text-sky-800'
                                      : 'bg-blue-100 text-blue-800'"
                                  [matTooltip]="entry.provider === 'google' ? 'Google' : entry.provider === 'azure' ? 'Microsoft Azure' : ''">
                                <mat-icon *ngIf="entry.provider === 'google'" svgIcon="eg_google"
                                          class="!text-[12px] !w-3 !h-3"></mat-icon>
                                <mat-icon *ngIf="entry.provider === 'azure'"
                                          class="!text-[12px] !w-3 !h-3">business</mat-icon>
                                {{entry.email}}
                            </span>
                        </ng-container>
                        <span class="hidden sm:inline">{{group.parent.createdAt | date:'short'}}</span>
                        <button mat-icon-button
                                *ngIf="canRetry(group)"
                                class="retry-btn"
                                (click)="retryProcess(group, $event)"
                                [disabled]="retryingGroupIds.has(group.parent.instanceId)"
                                matTooltip="Retry">
                            <mat-icon class="!text-[18px] !w-[18px] !h-[18px]">
                                {{retryingGroupIds.has(group.parent.instanceId) ? 'hourglass_empty' : 'replay'}}
                            </mat-icon>
                        </button>
                        <button mat-icon-button
                                class="delete-btn"
                                (click)="group.children.length > 0 ? purgeGroup(group, $event) : purgeInstance(group.parent.instanceId, $event)"
                                [disabled]="deletingInstanceIds.has(group.parent.instanceId)"
                                matTooltip="Delete">
                            <mat-icon class="!text-[18px] !w-[18px] !h-[18px]">
                                {{deletingInstanceIds.has(group.parent.instanceId) ? 'hourglass_empty' : 'delete_outline'}}
                            </mat-icon>
                        </button>
                        <mat-icon class="!text-[18px] !w-[18px] !h-[18px]">
                            {{expandedInstanceId === group.parent.instanceId ? 'expand_less' : 'expand_more'}}
                        </mat-icon>
                    </div>
                </div>
            </div>

            <!-- Expanded parent detail -->
            <div *ngIf="expandedInstanceId === group.parent.instanceId" class="px-4 pb-4 border-t">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4">
                    <div>
                        <div class="font-semibold mb-1">Details</div>
                        <div class="space-y-1 text-secondary">
                            <div>Instance ID: <span class="font-mono text-xs">{{group.parent.instanceId}}</span></div>
                            <div>Created: {{group.parent.createdAt | date:'medium'}}</div>
                            <div>Last Updated: {{group.parent.lastUpdatedAt | date:'medium'}}</div>
                            <div *ngIf="getStartedByEntries(group.parent).length > 0" class="flex items-center gap-2 flex-wrap">
                                Started by:
                                <span *ngFor="let entry of getStartedByEntries(group.parent); trackBy: trackByEmail"
                                      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium"
                                      [ngClass]="entry.provider === 'azure'
                                          ? 'bg-sky-100 text-sky-800'
                                          : 'bg-blue-100 text-blue-800'"
                                      [matTooltip]="entry.provider === 'google' ? 'Google' : entry.provider === 'azure' ? 'Microsoft Azure' : ''">
                                    <mat-icon *ngIf="entry.provider === 'google'" svgIcon="eg_google"
                                              class="!text-[12px] !w-3 !h-3"></mat-icon>
                                    <mat-icon *ngIf="entry.provider === 'azure'"
                                              class="!text-[12px] !w-3 !h-3">business</mat-icon>
                                    {{entry.email}}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="getMigrationSummary(group.parent) as summary">
                        <div class="font-semibold mb-1">Migration</div>
                        <div class="text-secondary space-y-1">
                            <div>From {{summary.from}}</div>
                            <div>To {{summary.to}}</div>
                        </div>
                    </div>
                </div>
                <!-- Copied files (succeeded) -->
                <div *ngIf="getSucceededFiles(group.parent).length > 0" class="mt-4">
                    <div class="font-semibold mb-2 text-sm flex items-center gap-1">
                        <mat-icon class="!text-base !w-4 !h-4 text-green-600">check_circle</mat-icon>
                        Copied Files ({{getSucceededFiles(group.parent).length}})
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <div *ngFor="let file of getSucceededFiles(group.parent)"
                             class="flex items-start gap-2 px-2 py-1.5 rounded-md text-xs bg-green-50 border border-green-200">
                            <mat-icon [ngClass]="file.isImage ? 'text-blue-500' : 'text-slate-400'"
                                      class="!text-sm !w-3.5 !h-3.5 mt-0.5 flex-shrink-0">
                                {{getFileIcon(file.name)}}
                            </mat-icon>
                            <div class="min-w-0">
                                <div class="font-medium">{{file.name}}</div>
                                <div class="text-secondary">{{file.source}} â†’ {{file.destination}}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Failed files -->
                <div *ngIf="getFailedFiles(group.parent).length > 0" class="mt-4">
                    <div class="font-semibold mb-2 text-sm flex items-center gap-1">
                        <mat-icon class="!text-base !w-4 !h-4 text-red-500">error_outline</mat-icon>
                        Failed Files ({{getFailedFiles(group.parent).length}})
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <details *ngFor="let file of getFailedFiles(group.parent)"
                                 class="rounded-md text-xs bg-red-50 border border-red-200">
                            <summary class="flex items-start gap-2 px-2 py-1.5 cursor-pointer select-none list-none [&::-webkit-details-marker]:hidden">
                                <mat-icon class="text-red-400 !text-sm !w-3.5 !h-3.5 mt-0.5 flex-shrink-0">error_outline</mat-icon>
                                <div class="min-w-0">
                                    <div class="font-medium break-all">{{file.name}}</div>
                                    <div class="text-red-600 truncate">{{getErrorSummary(file.error)}}</div>
                                </div>
                            </summary>
                            <div class="px-2 pb-2 ml-6 text-red-600 break-words whitespace-pre-wrap">{{file.error}}</div>
                        </details>
                    </div>
                </div>
                <!-- Fallback: input files when no output yet (pending/running) -->
                <div *ngIf="getSucceededFiles(group.parent).length === 0 && getFailedFiles(group.parent).length === 0 && getSelectedItems(group.parent).length > 0" class="mt-4">
                    <div class="font-semibold mb-2 text-sm flex items-center gap-1">
                        <mat-icon class="!text-base !w-4 !h-4">content_copy</mat-icon>
                        Selected ({{getSelectedItems(group.parent).length}})
                    </div>
                    <div class="flex flex-wrap gap-1.5">
                        <div *ngFor="let item of getSelectedItems(group.parent)"
                             class="flex items-center gap-1 px-2 py-1 rounded-md text-xs bg-slate-50 border border-slate-200"
                             [matTooltip]="item.path">
                            <mat-icon [ngClass]="item.isFolder ? 'text-amber-500' : item.isImage ? 'text-blue-500' : 'text-slate-400'"
                                      class="!text-sm !w-3.5 !h-3.5">
                                {{item.isFolder ? 'folder' : getFileIcon(item.name)}}
                            </mat-icon>
                            <span class="truncate max-w-[200px]">{{item.name}}</span>
                        </div>
                    </div>
                </div>
                <!-- Nested children -->
                <div *ngIf="group.children.length > 0" class="mt-4">
                    <div class="font-semibold mb-2 text-sm flex items-center gap-1">
                        <mat-icon class="!text-base !w-4 !h-4">account_tree</mat-icon>
                        Sub-orchestrators ({{group.children.length}})
                    </div>
                    <div class="space-y-2 ml-4 border-l-2 border-gray-200 pl-4">
                        <div *ngFor="let child of group.children"
                             class="rounded-lg p-3 text-sm bg-slate-50 border border-slate-200">
                            <div class="flex items-center justify-between gap-3">
                                <div class="flex items-center gap-2 min-w-0">
                                    <mat-icon [class]="statusColors[child.runtimeStatus]"
                                              class="!text-base !w-4 !h-4">
                                        {{statusIcons[child.runtimeStatus]}}
                                    </mat-icon>
                                    <span class="px-1.5 py-0.5 rounded text-xs font-semibold"
                                          [ngClass]="statusColors[child.runtimeStatus]">
                                        {{statusLabels[child.runtimeStatus]}}
                                    </span>
                                    <span class="font-medium truncate">{{getDisplayName(child.name)}}</span>
                                    <ng-container *ngIf="getSubProgress(child) as progress; else fileCount">
                                        <span class="text-xs text-secondary">
                                            ({{progress.completed}}/{{progress.total}})
                                        </span>
                                        <span *ngIf="progress.lastFile && child.runtimeStatus === 0"
                                              class="text-xs text-blue-600 truncate max-w-[200px]">
                                            {{progress.lastFile}}
                                        </span>
                                    </ng-container>
                                    <ng-template #fileCount>
                                        <span *ngIf="getChildFiles(child).length > 0"
                                              class="text-xs text-secondary">
                                            ({{getChildFiles(child).length}} files)
                                        </span>
                                    </ng-template>
                                </div>
                                <div class="flex items-center gap-2 text-xs text-secondary whitespace-nowrap">
                                    <span>{{child.createdAt | date:'short'}}</span>
                                    <button mat-icon-button
                                            class="delete-btn !w-7 !h-7"
                                            (click)="purgeInstance(child.instanceId, $event)"
                                            [disabled]="deletingInstanceIds.has(child.instanceId)"
                                            matTooltip="Delete sub-orchestrator">
                                        <mat-icon class="!text-base !w-4 !h-4">
                                            {{deletingInstanceIds.has(child.instanceId) ? 'hourglass_empty' : 'delete_outline'}}
                                        </mat-icon>
                                    </button>
                                </div>
                            </div>
                            <!-- File list -->
                            <div *ngIf="getChildFiles(child).length > 0" class="mt-2 flex flex-wrap gap-1.5">
                                <div *ngFor="let file of getChildFiles(child)"
                                     class="flex items-center gap-1 px-2 py-1 rounded-md text-xs bg-white border border-slate-200"
                                     [matTooltip]="file.path">
                                    <mat-icon [ngClass]="file.isImage ? 'text-blue-500' : 'text-slate-400'"
                                              class="!text-sm !w-3.5 !h-3.5">
                                        {{getFileIcon(file.name)}}
                                    </mat-icon>
                                    <span class="truncate max-w-[140px]">{{file.name}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- No matching results (filter active but nothing matches) -->
    <div *ngIf="!loading && groups.length === 0 && instances.length > 0 && !error"
         class="flex flex-auto flex-col items-center justify-center">
        <mat-icon class="!text-[80px] !w-20 !h-20 text-black/15">filter_list_off</mat-icon>
        <div class="mt-4 text-xl font-semibold tracking-tight text-secondary">No matching processes</div>
        <div class="mt-2 text-sm text-secondary">Try adjusting your filter criteria.</div>
    </div>

    <!-- Empty state (no data at all) -->
    <div *ngIf="!loading && instances.length === 0 && !error"
         class="flex flex-auto flex-col items-center justify-center">
        <mat-icon class="!text-[80px] !w-20 !h-20 text-black/15">hourglass_empty</mat-icon>
        <div class="mt-4 text-xl font-semibold tracking-tight text-secondary">No processes found</div>
        <div class="mt-2 text-sm text-secondary">Start a migration from the File Manager to see processes here.</div>
    </div>

</div>
