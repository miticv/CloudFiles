<div class="flex flex-col w-full h-full min-w-0 overflow-auto">

    <!-- Not connected state -->
    <div *ngIf="!isAzureConnected" class="flex flex-auto flex-col items-center justify-center py-16">
        <mat-icon class="!text-[80px] !w-20 !h-20 text-black/15">cloud_off</mat-icon>
        <div class="mt-4 text-xl font-semibold tracking-tight text-secondary">Azure Not Connected</div>
        <div class="mt-2 text-sm text-secondary mb-6">Connect your Azure account to browse your storage resources.</div>
        <button mat-flat-button color="primary" (click)="connectAzure()">
            <mat-icon>login</mat-icon>
            Connect Azure
        </button>
    </div>

    <!-- Connected state -->
    <ng-container *ngIf="isAzureConnected">

        <!-- Header -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between p-6 sm:py-8 md:px-8 border-b bg-card sticky top-0 z-10">
            <div>
                <div class="text-3xl font-bold tracking-tight leading-none">Storage Browser</div>
                <div class="mt-1 font-medium text-secondary">{{levelTitle}}</div>
            </div>
            <div class="flex items-center gap-1 mt-4 sm:mt-0">
                <button mat-icon-button class="header-btn" (click)="openHelp()" matTooltip="Help">
                    <mat-icon>help_outline</mat-icon>
                </button>
                <button mat-icon-button class="header-btn" (click)="loadSubscriptions()" matTooltip="Refresh">
                    <mat-icon>refresh</mat-icon>
                </button>
            </div>
        </div>

        <!-- Breadcrumbs -->
        <nav class="flex items-center mx-6 md:mx-8 mt-4 mb-4 text-sm">
            <button mat-button class="px-2 min-w-0" (click)="loadSubscriptions()">
                <mat-icon class="mr-1" style="font-size: 18px; width: 18px; height: 18px;">home</mat-icon>
                Subscriptions
            </button>
            <ng-container *ngFor="let crumb of breadcrumbs; let last = last">
                <mat-icon class="text-gray-400" style="font-size: 18px; width: 18px; height: 18px;">chevron_right</mat-icon>
                <button mat-button class="px-2 min-w-0" [disabled]="last" (click)="navigateToBreadcrumb(crumb)">
                    {{crumb.label}}
                </button>
            </ng-container>
        </nav>

        <!-- Loading -->
        <div *ngIf="loading" class="flex flex-auto flex-col items-center justify-center gap-4">
            <mat-spinner diameter="44" strokeWidth="4"></mat-spinner>
            <p class="text-sm font-medium text-secondary">Loading...</p>
        </div>

        <!-- Error -->
        <div *ngIf="error" class="mx-6 md:mx-8 mt-4 p-4 rounded-xl flex items-center gap-3 bg-red-50 border border-red-200">
            <mat-icon class="text-red-600 !text-[20px] !w-5 !h-5">error_outline</mat-icon>
            <span class="flex-1 text-sm text-red-800">{{error}}</span>
            <button mat-icon-button (click)="loadSubscriptions()" matTooltip="Retry">
                <mat-icon>refresh</mat-icon>
            </button>
        </div>

        <!-- Lists -->
        <div class="px-6 md:px-8 pb-6">

            <!-- Subscriptions list -->
            <mat-nav-list *ngIf="!loading && currentLevel === 'subscriptions'">
                <mat-list-item *ngFor="let sub of subscriptions" (click)="selectSubscription(sub)">
                    <mat-icon matListItemIcon class="text-blue-500">subscriptions</mat-icon>
                    <div matListItemTitle>{{sub.displayName}}</div>
                    <div matListItemLine class="text-secondary text-xs">{{sub.subscriptionId | slice:0:8}}...</div>
                    <span matListItemMeta><mat-icon class="trail-icon">chevron_right</mat-icon></span>
                </mat-list-item>
                <div *ngIf="subscriptions.length === 0" class="text-center py-8 text-secondary">
                    No subscriptions found.
                </div>
            </mat-nav-list>

            <!-- Resource Groups list -->
            <mat-nav-list *ngIf="!loading && currentLevel === 'resourceGroups'">
                <mat-list-item *ngFor="let rg of resourceGroups" (click)="selectResourceGroup(rg)">
                    <mat-icon matListItemIcon class="text-green-500">folder</mat-icon>
                    <div matListItemTitle>{{rg.name}}</div>
                    <div matListItemLine class="text-secondary text-xs">{{rg.location}}</div>
                    <span matListItemMeta><mat-icon class="trail-icon">chevron_right</mat-icon></span>
                </mat-list-item>
                <div *ngIf="resourceGroups.length === 0" class="text-center py-8 text-secondary">
                    No resource groups found.
                </div>
            </mat-nav-list>

            <!-- Storage Accounts list -->
            <mat-nav-list *ngIf="!loading && currentLevel === 'storageAccounts'">
                <mat-list-item *ngFor="let sa of storageAccounts" (click)="selectStorageAccount(sa)">
                    <mat-icon matListItemIcon class="text-amber-500">storage</mat-icon>
                    <div matListItemTitle>{{sa.name}}</div>
                    <div matListItemLine class="text-secondary text-xs">{{sa.location}} &middot; {{sa.accessTier}}</div>
                    <span matListItemMeta><mat-icon class="trail-icon">chevron_right</mat-icon></span>
                </mat-list-item>
                <div *ngIf="storageAccounts.length === 0" class="text-center py-8 text-secondary">
                    No storage accounts found.
                </div>
            </mat-nav-list>

            <!-- Containers list -->
            <mat-nav-list *ngIf="!loading && currentLevel === 'containers'">
                <mat-list-item *ngFor="let c of containers" (click)="selectContainer(c)"
                               [class.bg-blue-50]="selectedContainer?.name === c.name && accessState">
                    <mat-icon matListItemIcon class="text-teal-500">inventory_2</mat-icon>
                    <div matListItemTitle>{{c.name}}</div>
                    <div matListItemLine class="text-secondary text-xs">Last modified: {{c.lastModifiedTime | date}}</div>
                    <span matListItemMeta>
                        <mat-spinner *ngIf="selectedContainer?.name === c.name && (accessState === 'checking' || accessState === 'propagating')"
                                     diameter="20"></mat-spinner>
                        <mat-icon *ngIf="!(selectedContainer?.name === c.name && (accessState === 'checking' || accessState === 'propagating'))"
                                  class="trail-icon">open_in_new</mat-icon>
                    </span>
                </mat-list-item>
                <div *ngIf="containers.length === 0" class="text-center py-8 text-secondary">
                    No containers found.
                </div>
            </mat-nav-list>

            <!-- Access check panel (shown below container list) -->
            <div *ngIf="selectedContainer && accessState" class="mt-2 max-w-[720px]">

                <!-- Checking access -->
                <div *ngIf="accessState === 'checking'" class="p-4 rounded-xl flex items-center gap-3 text-sm text-secondary"
                     style="background: #f8fafc; border: 1px solid #e2e8f0;">
                    <mat-spinner diameter="18"></mat-spinner>
                    Checking read access for <strong class="ml-1">{{selectedContainer.name}}</strong>...
                </div>

                <!-- No role: Grant Reader Access -->
                <div *ngIf="accessState === 'no-role'" class="p-4 rounded-xl" style="background: #fff8e1; border: 1px solid #ffe082;">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-sm">
                            <mat-icon style="font-size: 18px; width: 18px; height: 18px;" class="text-amber-600">security</mat-icon>
                            <span><strong>Storage Blob Data Reader</strong> role is required to browse <strong>{{selectedContainer.name}}</strong>.</span>
                        </div>
                        <button mat-icon-button (click)="dismissAccessPanel()" matTooltip="Dismiss" class="!w-8 !h-8">
                            <mat-icon style="font-size: 18px;">close</mat-icon>
                        </button>
                    </div>
                    <button mat-flat-button color="primary" (click)="grantReadAccess()" [disabled]="grantingAccess" class="w-full">
                        <mat-spinner *ngIf="grantingAccess" diameter="18" class="mr-2 inline-block"></mat-spinner>
                        {{grantingAccess ? 'Granting access...' : 'Grant Read Access'}}
                    </button>
                    <div *ngIf="accessError" class="mt-2 text-xs" style="color: #b91c1c;">{{accessError}}</div>
                </div>

                <!-- Role assigned, waiting for propagation -->
                <div *ngIf="accessState === 'propagating'" class="p-4 rounded-xl flex items-center gap-3 text-sm"
                     style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534;">
                    <mat-spinner diameter="18"></mat-spinner>
                    Read access granted for <strong class="mx-1">{{selectedContainer.name}}</strong>. Waiting for propagation...
                </div>

                <!-- Access fully ready (auto-navigates, but shown briefly) -->
                <div *ngIf="accessState === 'ready'" class="p-4 rounded-xl flex items-center gap-2 text-sm"
                     style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534;">
                    <mat-icon style="font-size: 18px; width: 18px; height: 18px;">check_circle</mat-icon>
                    Read access confirmed. Opening <strong class="ml-1">{{selectedContainer.name}}</strong>...
                </div>
            </div>

        </div>

    </ng-container>
</div>
